# Chinese translation of [Dat protocol whitepaper](https://github.com/datproject/docs/blob/master/papers/dat-paper.md)

標題：Dat - 分佈式數據集同步和版本控制  
日期：2017 年 5 月（最後更新時間：2018 年 1 月）  
作者：Maxwell Ogden, Karissa McKelvey, Mathias Buus Madsen, Code for Science

# 概括

Dat 是一種協議，用於同步數據文件夾，即使它們很大或不斷變化。Dat 使用密碼學安全的變更註冊表，以證明所請求的數據版本是分佈式的。通過網絡連接，可以從 Dat 存儲庫有效地流式傳輸任何文件版本的字節範圍。消費者可以選擇完全或部分複製遠程 Dat 存儲庫的內容，也可以訂閱實時更改。為了確保作者和讀者的隱私，Dat 使用公鑰密碼學來加密網絡流量。一組 Dat 客戶端可以相互連接以形成公共或私有分散網絡，以在彼此之間交換數據。JavaScript 中提供了參考實現。

# 1\. 背景

在今天，HTTP 和 FTP 被用於在線共享許多數據集，這些數據集缺乏內置的版本控制或數據內容尋址支持。當文件被移動，更新或刪除時，這導致鏈接腐爛和內容漂移，導致數據參考以驚人的速度消失，例如[已發表的科學文獻](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0115253)領域。

像 S3 這樣的雲存儲服務可確保數據的可用性，但它們具有集中式中心輻射網絡模型，因此受到帶寬的限制，這意味著流行文件的共享成本非常高。像 Dropbox 和 Google Drive 這樣的服務在雲存儲服務之上提供版本控制和同步機制，這解決了鏈接損壞的許多問題，但依賴於專有代碼和服務，並強制要求用戶將數據存儲在集中式雲基礎架構上，這會對成本、傳輸速度、供應商鎖定和用戶隱私產生影響。

當文件變得越來越流行，分佈式文件共享工具可以變得更快，消除帶寬瓶頸並使文件分發更便宜。他們還使用鏈接解析和發現系統來防止鏈接斷開，這意味著如果原始源脫機，則可以自動發現其他備份源。但是，Web 瀏覽器目前不支持這些文件共享工具，沒有良好的隱私保證，也沒有提供無需重新分發新數據集（這意味著可能完全重新下載您已有的數據）的文件更新機制。

# 2\. Dat

Dat 是一種數據集同步協議，它不假設數據集是靜態的，也不強制要求下載整個數據集。主要的參考實現可以從 npm 獲得：`npm install dat -g`

該協議與底層傳輸無關，比如說你可以通過信鴿實現 Dat。數據以稱為 SLEEP 的格式存儲（見另一篇文章）。本節將介紹 Dat 設計的關鍵屬性。

*   2.1 **內容完整性** - 通過使用內容的簽名散列 (hash) 來驗證數據和發佈者的完整性。
*   2.2 **分散化鏡像** - 共享相同 Dat 的用戶自動發現彼此並在集群中交換數據。
*   2.3 **網絡隱私** - Dat 提供某些隱私保證，包括端到端加密。
*   2.4 **增量版本控制** - 數據集甚至可以實時有效地同步到其他對等體。
*   2.5 **隨機訪問** - 可以遠程有效地遍歷大型文件層次結構。

## 2.1 內容完整性

內容完整性意味著能夠驗證您收到的數據與您預期的數據完全相同。這在分佈式系統中很重要，因為這種機制會捕獲壞對等體 (bad peers) 發送的錯誤數據。它還具有可復現性 (reproducibility) 的含義，因為它可以讓您引用特定版本的數據集。

鏈接腐爛（鏈接在線停止解析），以及內容漂移（數據發生變化但數據鏈接保持不變），是數據分析中的兩個常見問題。例如，有一天名為 data.zip 的文件可能會更改，但是典型的 HTTP 文件鏈接不包含內容的散列，也不提供獲取更新元數據的方法，所以如果不重新下載整個文件，只有 HTTP 鏈接的客戶端無法檢查文件是否更改。Dat 使用 BLAKE2b 密碼學安全散列來處理內容 (to address content)。散列佈置在 Merkle 樹中，其中每個非葉節點是所有子節點的散列，葉節點包含數據集的各個部分。由於密碼學安全散列的屬性，只有在其下面的所有數據完全匹配時才能生成頂部散列。如果兩個樹具有匹配的頂部散列，那麼您就知道樹中的所有其他節點也必須匹配，並且您可以得出結論，您的數據集是同步的。

### Dat 鏈接

數據鏈接是 Ed25519 公鑰，長度為 32 個字節（十六進制編碼時為 64 個字符）。您可以通過以下方式表示您的 Dat 鏈接，Dat 客戶端將能夠理解它們：

*   獨自 (standalone) 公鑰：
    `8e1c7189b1b2dbb5c4ec2693787884771201da9...`

*   使用 dat:// 協議：
    `dat://8e1c7189b1b2dbb5c4ec2693787884771...`

*   作為 HTTP URL 的一部分：
    `https://datproject.org/8e1c7189b1b2dbb5...`

Dat 協議中的所有消息都在傳輸過程中使用公鑰進行加密和簽名。這意味著除非您知道公鑰（例如，除非與您共享 Dat 鏈接），否則您將無法發現或與該集群的任何成員通信。具有公鑰的任何人都可以驗證私鑰的持有者是否創建了消息（例如 Dat 中的條目）。

每個 Dat 存儲庫都有一個相應的私鑰，該私鑰保存在您的主文件夾 (home folder) 中，永遠不會共享。Dat 絕不會通過網絡暴露公鑰或私鑰。在發現階段期間，公鑰的 BLAKE2b 散列被用作發現 key。這意味著原始 key 是不可能發現的（除非它是通過單獨的渠道公開共享），因為只有 key 的散列被公開暴露。

Dat 目前不提供身份驗證機制。相反，它提供了一個能耐 (capability) 系統。目前，任何具有 Dat 鏈接的人都被認為能夠發現和訪問數據。如果您不希望訪問它們，請不要公開共享您的 Dat 鏈接。

### Hypercore 與 Hyperdrive

Dat 存儲，內容完整性和網絡協議在名為 [Hypercore](https://www.npmjs.com/package/hypercore) 的模塊中實現。Hypercore 與輸入數據的格式無關，它可以在任何二進制數據流上運行。對於同步數據集的 Dat 用例，我們在 Hypercore 之上使用名為 [Hyperdrive](https://www.npmjs.com/package/hyperdrive) 的文件系統模塊。

Dat 具有分層抽象，因此用戶可以直接使用 Hypercore 來完全控制他們對數據建模的方式。當您的數據可以表示為文件系統上的文件時，Hyperdrive 運行良好，這是 Dat 的主要用例。

### Hypercore 註冊表

Hypercore 註冊表是 Dat 中使用的核心機制。它們是二進制僅附加 (append-only) 流，其內容以密碼學方式進行散列和簽名，因此可以由任何有權訪問作者公鑰的人進行驗證。它們是稱為註冊表的概念的實現，是您可以信任的數字分類帳。

Dat 使用兩個註冊表，`內容`和`元數據`。`內容`註冊表包含存儲庫中的文件，`元數據`包含有關文件的元數據，包括名稱、大小、上次修改時間等。Dat 在與另一個對等體同步時複製它們。

當文件被添加到 Dat 時，每個文件被分割成若干個塊，然後將塊排列成 Merkle 樹，稍後用於版本控制和複製過程。

## 2.2 分散化鏡像

Dat 是一種點對點協議，旨在在一群對等體之間交換數據集的各個部分。一旦對等體獲取了數據集中的第一條數據，它們就可以選擇成為數據集的部分鏡像。如果其他人聯繫他們並需要他們擁有的部分，他們可以選擇分享。當對等體仍在從其他人那裡下載他們想要的部分時，這可以同時發生。（譯註：換句話說，一邊下載未知部分，一邊上傳已知部分）

### 源發現

鏡像的一個重要方面是源發現，即對等體用於找到彼此的技術。源發現意味著在線查找數據源的 IP 和端口，其中具有您正在查找的數據副本。然後，您可以連接到它們並開始交換數據。通過使用源發現技術，Dat 能夠創建一個網絡，即使原始數據源消失，也可以發現數據。

*   `join(key, [port])` - 開始對 `key` 定期執行常規查找。如果你想宣佈你也分享 `key`，請指定 `port`。
*   `leave(key, [port])` - 停止尋找 `key`。指定 `port` 停止宣佈你也分享 `key`。
*   `foundpeer(key, ip, port)` - 當查找找到對等體時，被調用。

在 Dat 實現中，我們在三種類型的發現網絡之上實現上述操作：

*   DNS 名稱服務器 - 用於解析地址 key 的 Internet 標準機制
*   多播 DNS - 用於在本地網絡上發現對等體
*   Kademlia Mainline DHT（分佈式散列表） - 減少單點故障，即使 DNS 服務器無法訪問，也會增加 Dat 工作的可能性

可以根據需要實現其他發現網絡。我們選擇上述三個作為起點，採用互補的策略組合來增加源發現的可能性。此外，您可以通過 HTTPS 鏈接指定 Dat，該鏈接以「單源」模式運行 Dat 協議，這意味著不使用上述發現網絡，而只使用一個 HTTPS 服務器作為唯一的對等體。

### 對等體連接

在發現階段之後，Dat 應該有一個潛在的數據源列表來嘗試和聯繫。Dat 使用 TCP，HTTP 或 UTP。UTP 使用 LEDBAT，其設計為不佔用網絡上的所有可用帶寬（例如，使得共享 WiFi 的其他人仍然可以使用 Internet），並且仍然基於 UDP，因此使用諸如 UDP 打孔的 NAT 遍歷技術。支持 HTTP 以與靜態文件服務器和 Web 瀏覽器客戶端兼容。請注意，這些是我們在參考 Dat 實現中支持的協議，但 Dat 協議本身與傳輸無關。

如果指定了 HTTP 源，則 Dat 將其優先於其他源。或者，當 Dat 獲取潛在 TCP 或 UTP 源的 IP 和端口時，它會嘗試使用這兩種協議進行連接。如果其中一個首先連接，則 Dat 中止另一個。如果沒有連接，Dat 將再次嘗試，直到它確定源是下線或不可用，然後停止嘗試連接它們。能夠連接的源 Dat 會加入到已知的良好源列表，以便在 Internet 連接斷開時，可以使用該列表快速重新連接到已知的良好源。

如果 Dat 獲得了很多潛在的源，它會隨機選擇一小部分來嘗試連接並保留其餘部分作為額外的源，以便以後使用它以確定它需要更多的源。

一旦與遠程源的雙工二進制連接打開，則在 Hypercore 協議上進行分層，這是一種基於消息的複製協議，允許兩個對等體通過無狀態通道進行通信以請求和交換數據。您可以同時打開具有多個對等體的單獨複製通道，這允許客戶端在已建立連接的整個對等體池 (pool) 中並行化數據請求。

## 2.3 網絡隱私

在今天的 Web 上，通過 SSL，可以保證計算機和服務器之間的流量是私有的。只要您信任服務器不洩漏日誌，攔截您的網絡流量的攻擊者將無法讀取您與服務器之間交換的 HTTP 流量。這是一個相當簡單的模型，因為客戶端只需要信任某個域的單個服務器。

在的 P2P 系統中，源發現 vs 用戶隱私之間存在固有的權衡。您聯繫並索取某些數據的源越多，您需要信任會為您保密的源就越多。我們的目標是讓 Dat 可以根據權衡進行配置，以允許應用程序開發人員滿足他們自己的隱私準則。

客戶端程序可以自己做出設計決策，決定信任何種發現網絡。例如，如果 Dat 客戶端決定使用 BitTorrent DHT 來發現對等體，並且他們正在搜索具有已知內容的公共共享 Dat key（例如，在已發表的科學論文中公開引用的 key），然後，因為 BitTorrent DHT 的隱私設計，客戶正在尋找的內容將被公開。

客戶可以選擇僅使用具有某些隱私保證的發現網絡。例如，客戶只連接到他們信任的已批准源列表，類似於 SSL。只要信任每個源，Dat 網絡協議中內置的加密將阻止他們正在尋找的 Dat key 洩露。（譯註：類似於 Private Tracker）

## 2.4 增量版本控制

給定二進制數據流 (stream)，Dat將流拆分為塊 (chunk)，計算每個塊的散列，並在特定類型的Merkle樹中排列散列，以允許某些複製屬性。

即使正在追加流，Dat也能夠在分佈式設置中完全或部分同步流。這是通過 使用消息傳遞協議遍歷遠程源的Merkle樹並獲取一組戰略節點 來實現的。由於複製 (replication) 協議的低級、面向消息的設計，可以實現不同的節點遍歷策略。

Dat自動執行兩種版本控制。元數據存儲在存儲庫的根文件夾中名為 `.dat` 的文件夾中，數據作為普通文件存儲在根文件夾中。

**（未完待續）**
